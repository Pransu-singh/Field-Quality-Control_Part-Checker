{% extends "base.html" %}

{% block title %}Manage Admins{% endblock %}

 


{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-user-shield me-2"></i>Manage Admins</h2>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="showAddAdminModal('ADMIN')">
                <i class="fas fa-user-plus me-1"></i>Add Admin
            </button>
            <button class="btn btn-danger" onclick="showAddAdminModal('IT_ADMIN')">
                <i class="fas fa-user-shield me-1"></i>Add IT Admin
            </button>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Type</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for admin in admins %}
                        <tr>
                            <td>{{ admin.employee_id }}</td>
                            <td>{{ admin.first_name }} {{ admin.last_name }}</td>
                            <td>{{ admin.username }}</td>
                            <td>
                                <span class="badge {% if admin.user_type == 'IT_ADMIN' %}bg-danger{% else %}bg-primary{% endif %}">
                                    {{ admin.user_type }}
                                </span>
                            </td>
                            <td>{{ admin.email }}</td>
                            <td>{{ admin.phone_number }}</td>
                            <td>
                                <span class="badge {% if admin.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ 'Active' if admin.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editAdmin('{{ admin.employee_id }}')">
                                    <i class="fas fa-edit icon-blue"></i>

                                </button>
                                {% if admin.employee_id != current_user.employee_id %}
                                <button class="btn btn-sm {% if admin.is_active %}btn-outline-danger{% else %}btn-outline-success{% endif %}" 
                                        onclick="toggleAdminStatus('{{ admin.employee_id }}')">
                                    <i class="fas {% if admin.is_active %}fa-user-slash{% else %}fa-user-check{% endif %}"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% include 'partials/_admin_modals.html' %}
{% endblock %}

{% block extra_js %}
<script>
function togglePassword(button) {
    const input = button.previousElementSibling;
    const icon = button.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function showAddAdminModal(type = 'ADMIN') {
    const modalEl = document.getElementById('addAdminModal');
    const modal = new bootstrap.Modal(modalEl);

    const userTypeSelect = modalEl.querySelector('select[name="user_type"]');
    if (userTypeSelect) {
        userTypeSelect.value = type;
    }

    modal.show();
}

function editAdmin(employeeId) {
    fetch(`/admin/${employeeId}`)
        .then(response => response.json())
        .then(data => {
            const form = document.getElementById('editAdminForm');
            form.employee_id.value = data.employee_id;
            form.username.value = data.username;
            form.user_type.value = data.user_type;
            form.first_name.value = data.first_name;
            form.last_name.value = data.last_name;
            form.email.value = data.email;
            form.phone_number.value = data.phone_number;
            form.password.value = '';
            new bootstrap.Modal(document.getElementById('editAdminModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load admin details');
        });
}

function toggleAdminStatus(employeeId) {
    if (confirm('Are you sure you want to change this admin\'s status?')) {
        fetch(`/toggle_admin/${employeeId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || data.error || 'Failed to update admin status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update admin status');
        });
    }
}

function submitAddAdmin() {
    const form = document.getElementById('addAdminForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    if (!data.username?.trim()) {
        alert("Username is required");
        return;
    }
    if (!data.first_name?.trim()) {
        alert("First name is required");
        return;
    }
    if (!data.last_name?.trim()) {
        alert("Last name is required");
        return;
    }
     


    const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
    const phoneRegex = /^\d{10}$/;

    if (!emailRegex.test(data.email)) {
        alert("Invalid email format");
        return;
    }

    if (!phoneRegex.test(data.phone_number)) {
        alert("Mobile number must be 10 digits");
        return;
    }


    

    fetch('/add_admin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message || data.error || 'Failed to add admin');
        }
    });
}

function submitEditAdmin() {
    const form = document.getElementById('editAdminForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    if (!data.password) delete data.password;
    if (!data.username?.trim()) {
        alert("Username is required");
        return;
    }
    if (!data.first_name?.trim()) {
        alert("First name is required");
        return;
    }
    if (!data.last_name?.trim()) {
        alert("Last name is required");
        return;
    }


    const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
    const phoneRegex = /^\d{10}$/;

    if (!emailRegex.test(data.email)) {
        alert("Invalid email format");
        return;
    }

    if (!phoneRegex.test(data.phone_number)) {
        alert("Mobile number must be 10 digits");
        return;
    }
     
    fetch(`/update_admin/${data.employee_id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message || data.error || 'Failed to update admin');
        }
    });
}
</script>
{% endblock %}
